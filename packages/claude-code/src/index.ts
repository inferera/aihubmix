import { existsSync } from "fs";
import { writeFile } from "fs/promises";
import { homedir } from "os";
import { join } from "path";
import { initConfig, initDir } from "./config";
import { createServer } from "./services/server";
import { router } from "./core/router";
import { apiKeyAuth } from "./middleware/auth";
import {
  cleanupPidFile,
  isServiceRunning,
  savePid,
} from "./utils/processCheck";
import { CONFIG_FILE } from "./constants";
import { RunOptions } from "./types/index";

async function initializeClaudeConfig() {
  const homeDir = homedir();
  const configPath = join(homeDir, ".claude.json");
  if (!existsSync(configPath)) {
    const userID = Array.from(
      { length: 64 },
      () => Math.random().toString(16)[2]
    ).join("");
    const configContent = {
      numStartups: 184,
      autoUpdaterStatus: "enabled",
      userID,
      hasCompletedOnboarding: true,
      lastOnboardingVersion: "1.0.17",
      projects: {},
    };
    await writeFile(configPath, JSON.stringify(configContent, null, 2));
  }
}

async function run(options: RunOptions = {}) {
  // Check if service is already running
  if (isServiceRunning()) {
    console.log("âœ… Service is already running in the background.");
    return;
  }

  await initializeClaudeConfig();
  await initDir();
  
  // Initialize config (will try config file first, then environment variables)
  const config = await initConfig();
  
  // Log configuration source
  if (process.env.AIHUBMIX_API_KEY) {
    console.log("âœ… Using API_KEY from environment variable");
  } else {
    console.log("âœ… Using API_KEY from config file");
  }
  
  let HOST = config.HOST || "127.0.0.1";
  const port = config.PORT || 3456;

  // Save the PID of the background process
  savePid(process.pid);

  // Handle SIGINT (Ctrl+C) to clean up PID file
  process.on("SIGINT", () => {
    console.log("Received SIGINT, cleaning up...");
    cleanupPidFile();
    process.exit(0);
  });

  // Handle SIGTERM to clean up PID file
  process.on("SIGTERM", () => {
    cleanupPidFile();
    process.exit(0);
  });
  
  console.log(`ðŸš€ Starting server on ${HOST}:${port}`);

  // Use port from environment variable if set (for background process)
  const servicePort = process.env.SERVICE_PORT
    ? parseInt(process.env.SERVICE_PORT)
    : port;

  const server = createServer({
    jsonPath: CONFIG_FILE,
    initialConfig: {
      providers: [
        {
          name: "aihubmix",
          api_base_url: "https://aihubmix.com/v1/chat/completions",
          api_key: config.API_KEY,
          models: [
            "AiHubmix-Phi-4-mini-reasoning",
            "AiHubmix-Phi-4-reasoning",
            "AiHubmix-mistral-medium",
            "Aihubmix-MAI-DS-R1",
            "Baichuan3-Turbo",
            "Baichuan3-Turbo-128k",
            "Baichuan4",
            "Baichuan4-Air",
            "Baichuan4-Turbo",
            "DESCRIBE",
            "DeepSeek-R1",
            "DeepSeek-R1-0528",
            "DeepSeek-R1-Distill-Qwen-32B",
            "DeepSeek-R1-Distill-Qwen-7B",
            "DeepSeek-V3",
            "DeepSeek-V3-Fast",
            "Doubao-1.5-lite-32k",
            "Doubao-1.5-pro-256k",
            "Doubao-1.5-pro-32k",
            "Doubao-1.5-thinking-pro",
            "Doubao-1.5-vision-pro-32k",
            "Doubao-lite-128k",
            "Doubao-lite-32k",
            "Doubao-lite-4k",
            "Doubao-pro-128k",
            "Doubao-pro-256k",
            "Doubao-pro-32k",
            "Doubao-pro-4k",
            "GLM-4.5",
            "Kimi-K2",
            "Llama-4-Maverick-17B-128E-Instruct-FP8",
            "Llama-4-Scout-17B-16E-Instruct",
            "MiniMax-Text-01",
            "MiniMaxAI/MiniMax-M1-80k",
            "Mistral-large-2407",
            "Pro/THUDM/GLM-4.1V-9B-Thinking",
            "QwQ-32B",
            "Qwen/QVQ-72B-Preview",
            "Qwen/QwQ-32B",
            "Qwen/QwQ-32B-Preview",
            "Qwen/Qwen2-7B-Instruct",
            "Qwen/Qwen2.5-32B-Instruct",
            "Qwen/Qwen2.5-72B-Instruct",
            "Qwen/Qwen2.5-72B-Instruct-128K",
            "Qwen/Qwen2.5-7B-Instruct",
            "Qwen/Qwen2.5-Coder-32B-Instruct",
            "Qwen/Qwen2.5-VL-32B-Instruct",
            "Qwen/Qwen2.5-VL-72B-Instruct",
            "Qwen/Qwen3-14B",
            "Qwen/Qwen3-235B-A22B",
            "Qwen/Qwen3-235B-A22B-Instruct-2507",
            "Qwen/Qwen3-30B-A3B",
            "Qwen/Qwen3-32B",
            "Qwen/Qwen3-8B",
            "Qwen/Qwen3-Coder-30B-A3B-Instruct",
            "Qwen/Qwen3-Embedding-0.6B",
            "Qwen2-VL-72B-Instruct",
            "Qwen2-VL-7B-Instruct",
            "Qwen3-235B-A22B-Instruct-2507",
            "Qwen3-Coder",
            "THUDM/GLM-4-32B-0414",
            "THUDM/GLM-4-9B-0414",
            "THUDM/GLM-4.1V-9B-Thinking",
            "THUDM/GLM-Z1-32B-0414",
            "THUDM/GLM-Z1-9B-0414",
            "UPSCALE",
            "V3",
            "V_1",
            "V_1_TURBO",
            "V_2",
            "V_2A",
            "V_2A_TURBO",
            "V_2_TURBO",
            "Z/glm-4.5",
            "Z/glm-4.5-air",
            "ahm-Phi-3-5-MoE-instruct",
            "ahm-Phi-3-5-mini-instruct",
            "ahm-Phi-3-5-vision-instruct",
            "ahm-Phi-3-medium-128k",
            "ahm-Phi-3-medium-4k",
            "ahm-Phi-3-small-128k",
            "aihub-Phi-4",
            "aihub-Phi-4-mini-instruct",
            "aihub-Phi-4-multimodal-instruct",
            "aihubmix-Codestral-2501",
            "aihubmix-Cohere-command-r",
            "aihubmix-DeepSeek-R1",
            "aihubmix-DeepSeek-V3-0324",
            "aihubmix-Jamba-1-5-Large",
            "aihubmix-Llama-3-1-405B-Instruct",
            "aihubmix-Llama-3-1-70B-Instruct",
            "aihubmix-Llama-3-1-8B-Instruct",
            "aihubmix-Llama-3-2-11B-Vision",
            "aihubmix-Llama-3-2-90B-Vision",
            "aihubmix-Llama-3-3-70B-Instruct",
            "aihubmix-Llama-3-70B-Instruct",
            "aihubmix-Mistral-Large-2411",
            "aihubmix-Mistral-large",
            "aihubmix-Mistral-large-2407",
            "aihubmix-command-r-08-2024",
            "aihubmix-command-r-plus",
            "aihubmix-command-r-plus-08-2024",
            "aihubmix-router",
            "anthropic-3-5-sonnet-20240620",
            "anthropic-3-5-sonnet-20241022",
            "anthropic-3-7-sonnet-20250219",
            "azure-DeepSeek-R1-0528",
            "baidu/ERNIE-4.5-300B-A47B",
            "chatgpt-4o-latest",
            "chutesai/Llama-4-Maverick-17B-128E-Instruct-FP8",
            "chutesai/Llama-4-Scout-17B-16E-Instruct",
            "chutesai/Mistral-Small-3.1-24B-Instruct-2503",
            "claude-3-5-haiku-20241022",
            "claude-3-5-haiku-latest",
            "claude-3-5-sonnet-20240620",
            "claude-3-5-sonnet-20241022",
            "claude-3-5-sonnet-latest",
            "claude-3-5-sonnet@20240620",
            "claude-3-7-sonnet-20250219",
            "claude-3-haiku-20240307",
            "claude-3-opus-20240229",
            "claude-3-sonnet-20240229",
            "claude-opus-4-0",
            "claude-opus-4-20250514",
            "claude-sonnet-4-0",
            "claude-sonnet-4-20250514",
            "codestral-latest",
            "codex-mini-latest",
            "cogview-3-plus",
            "command",
            "command-a-03-2025",
            "command-light",
            "command-light-nightly",
            "command-nightly",
            "command-r",
            "command-r-08-2024",
            "command-r-plus",
            "command-r-plus-08-2024",
            "computer-use-preview",
            "dall-e-2",
            "dall-e-3",
            "davinci-002",
            "deepseek-ai/DeepSeek-Prover-V2-671B",
            "deepseek-ai/DeepSeek-R1",
            "deepseek-ai/DeepSeek-R1-0528",
            "deepseek-ai/DeepSeek-R1-Distill-Qwen-1.5B",
            "deepseek-ai/DeepSeek-R1-Distill-Qwen-14B",
            "deepseek-ai/DeepSeek-R1-Distill-Qwen-32B",
            "deepseek-ai/DeepSeek-R1-Distill-Qwen-7B",
            "deepseek-ai/DeepSeek-R1-Zero",
            "deepseek-ai/DeepSeek-V2.5",
            "deepseek-ai/DeepSeek-V3",
            "deepseek-ai/DeepSeek-V3-0324",
            "deepseek-ai/deepseek-vl2",
            "deepseek-chat",
            "deepseek-r1-250120",
            "deepseek-r1-250528",
            "deepseek-r1-distill-llama-70b",
            "deepseek-reasoner",
            "deepseek-v3-250324",
            "distil-whisper-large-v3-en",
            "doubao-embedding-large-text-240915",
            "doubao-embedding-text-240715",
            "doubao-seed-1-6-250615",
            "doubao-seed-1-6-flash-250615",
            "doubao-seed-1-6-thinking-250615",
            "ernie-4.5-0.3b",
            "ernie-4.5-turbo-128k-preview",
            "ernie-4.5-turbo-vl-32k-preview",
            "ernie-x1-turbo-32k-preview",
            "flux-kontext-max",
            "flux-kontext-pro",
            "gemini-1.5-flash",
            "gemini-1.5-flash-002",
            "gemini-1.5-flash-exp-0827",
            "gemini-1.5-pro",
            "gemini-1.5-pro-002",
            "gemini-1.5-pro-exp-0801",
            "gemini-1.5-pro-exp-0827",
            "gemini-2.0-flash",
            "gemini-2.0-flash-001",
            "gemini-2.0-flash-exp",
            "gemini-2.0-flash-exp-image-generation",
            "gemini-2.0-flash-exp-search",
            "gemini-2.0-flash-lite",
            "gemini-2.0-flash-lite-001",
            "gemini-2.0-flash-lite-preview-02-05",
            "gemini-2.0-flash-preview-image-generation",
            "gemini-2.0-flash-search",
            "gemini-2.0-flash-thinking-exp",
            "gemini-2.0-flash-thinking-exp-01-21",
            "gemini-2.0-flash-thinking-exp-1219",
            "gemini-2.0-pro-exp-02-05",
            "gemini-2.0-pro-exp-02-05-search",
            "gemini-2.5-flash",
            "gemini-2.5-flash-lite",
            "gemini-2.5-flash-lite-preview-06-17",
            "gemini-2.5-flash-nothink",
            "gemini-2.5-flash-preview-04-17",
            "gemini-2.5-flash-preview-05-20",
            "gemini-2.5-flash-search",
            "gemini-2.5-pro",
            "gemini-2.5-pro-exp-03-25",
            "gemini-2.5-pro-preview-03-25",
            "gemini-2.5-pro-preview-03-25-search",
            "gemini-2.5-pro-preview-05-06",
            "gemini-2.5-pro-preview-05-06-search",
            "gemini-2.5-pro-preview-06-05",
            "gemini-2.5-pro-preview-06-05-search",
            "gemini-2.5-pro-search",
            "gemini-embedding-001",
            "gemini-embedding-exp-03-07",
            "gemini-exp-1114",
            "gemini-exp-1121",
            "gemini-exp-1206",
            "gemma-3-12b-it",
            "gemma-3-1b-it",
            "gemma-3-27b-it",
            "gemma-3-4b-it",
            "gemma-3n-e4b-it",
            "gemma2-9b-it",
            "glm-3-turbo",
            "glm-4",
            "glm-4-flash",
            "glm-4-plus",
            "glm-4.5",
            "glm-4.5-air",
            "glm-4.5-airx",
            "glm-4.5-flash",
            "glm-4.5-x",
            "glm-zero-preview",
            "google/gemma-2-27b-it",
            "google/gemma-3-27b-it",
            "gpt-3.5-turbo",
            "gpt-3.5-turbo-0125",
            "gpt-3.5-turbo-1106",
            "gpt-3.5-turbo-16k",
            "gpt-3.5-turbo-instruct",
            "gpt-4",
            "gpt-4-0125-preview",
            "gpt-4-0613",
            "gpt-4-1106-preview",
            "gpt-4-32k",
            "gpt-4-turbo",
            "gpt-4-turbo-2024-04-09",
            "gpt-4-turbo-preview",
            "gpt-4-vision-preview",
            "gpt-4.1",
            "gpt-4.1-mini",
            "gpt-4.1-nano",
            "gpt-4.5-preview",
            "gpt-4.5-preview-2025-02-27",
            "gpt-4o",
            "gpt-4o-2024-05-13",
            "gpt-4o-2024-08-06",
            "gpt-4o-2024-11-20",
            "gpt-4o-audio-preview",
            "gpt-4o-audio-preview-2024-10-01",
            "gpt-4o-image",
            "gpt-4o-image-vip",
            "gpt-4o-mini",
            "gpt-4o-mini-2024-07-18",
            "gpt-4o-mini-audio-preview",
            "gpt-4o-mini-search-preview",
            "gpt-4o-mini-tts",
            "gpt-4o-search-preview",
            "gpt-5",
            "gpt-5(high)",
            "gpt-5(medium)",
            "gpt-5(low)",
            "gpt-5(minimal)",
            "gpt-image-1",
            "grok-3",
            "grok-3-beta",
            "grok-3-mini",
            "grok-3-mini-beta",
            "imagen-3.0-generate-002",
            "imagen-4.0-generate-preview-05-20",
            "imagen-4.0-generate-preview-06-06",
            "imagen-4.0-ultra-generate-exp-05-20",
            "imagen-4.0-ultra-generate-preview-06-06",
            "jina-colbert-v2",
            "jina-deepsearch-v1",
            "jina-embeddings-v2-base-code",
            "jina-embeddings-v3",
            "jina-embeddings-v4",
            "jina-reranker-m0",
            "kimi-k2-0711-preview",
            "kimi-k2-turbo-preview",
            "kimi-latest",
            "kimi-thinking-preview",
            "learnlm-1.5-pro-experimental",
            "llama-3.1-405b-instruct",
            "llama-3.1-70b",
            "llama-3.1-70b-versatile",
            "llama-3.1-8b-instant",
            "llama-3.2-11b-vision-preview",
            "llama-3.2-1b-preview",
            "llama-3.2-3b-preview",
            "llama-3.2-90b-vision-preview",
            "llama-3.3-70b-versatile",
            "llama3-70b-8192",
            "llama3-8b-8192",
            "meta-llama/llama-4-scout-17b-16e-instruct",
            "moonshot-v1-128k",
            "moonshot-v1-128k-vision-preview",
            "moonshot-v1-32k",
            "moonshot-v1-32k-vision-preview",
            "moonshot-v1-8k",
            "moonshot-v1-8k-vision-preview",
            "moonshotai/Kimi-Dev-72B",
            "moonshotai/Moonlight-16B-A3B-Instruct",
            "moonshotai/kimi-k2-instruct",
            "nvidia/Llama-3_1-Nemotron-Ultra-253B-v1",
            "nvidia/llama-3.1-nemotron-70b-instruct",
            "o1",
            "o1-2024-12-17",
            "o1-mini",
            "o1-mini-2024-09-12",
            "o1-preview",
            "o1-preview-2024-09-12",
            "o1-pro",
            "o3",
            "o3-mini",
            "o3-pro",
            "o4-mini",
            "omni-moderation-latest",
            "qianfan-qi-vl",
            "qwen-long",
            "qwen-max",
            "qwen-max-0125",
            "qwen-max-longcontext",
            "qwen-plus",
            "qwen-plus-2025-04-28",
            "qwen-plus-latest",
            "qwen-qwq-32b",
            "qwen-turbo",
            "qwen-turbo-2024-11-01",
            "qwen-turbo-2025-04-28",
            "qwen-turbo-latest",
            "qwen2.5-14b-instruct",
            "qwen2.5-32b-instruct",
            "qwen2.5-3b-instruct",
            "qwen2.5-72b-instruct",
            "qwen2.5-7b-instruct",
            "qwen2.5-coder-1.5b-instruct",
            "qwen2.5-coder-7b-instruct",
            "qwen2.5-math-72b-instruct",
            "qwen2.5-math-7b-instruct",
            "qwen2.5-vl-72b-instruct",
            "qwen3-0.6b",
            "qwen3-1.7b",
            "qwen3-14b",
            "qwen3-235b-a22b",
            "qwen3-235b-a22b-instruct-2507",
            "qwen3-235b-a22b-thinking-2507",
            "qwen3-30b-a3b",
            "qwen3-30b-a3b-instruct-2507",
            "qwen3-30b-a3b-thinking-2507",
            "qwen3-32b",
            "qwen3-4b",
            "qwen3-8b",
            "qwen3-coder-480b-a35b-instruct",
            "qwen3-coder-plus-2025-07-22",
            "step-2-16k",
            "tencent/Hunyuan-A13B-Instruct",
            "text-ada-001",
            "text-babbage-001",
            "text-davinci-002",
            "text-davinci-003",
            "text-davinci-edit-001",
            "text-embedding-004",
            "text-embedding-3-large",
            "text-embedding-3-small",
            "text-embedding-ada-002",
            "text-embedding-v4",
            "text-moderation-stable",
            "tngtech/DeepSeek-R1T-Chimera",
            "tts-1",
            "tts-1-hd",
            "unsloth/gemma-3-12b-it",
            "unsloth/gemma-3-27b-it",
            "veo-2.0-generate-001",
            "veo-3",
            "veo-3.0-generate-preview",
            "whisper-1",
            "whisper-large-v3",
            "yi-large",
            "yi-large-rag",
            "yi-large-turbo",
            "yi-lightning",
            "yi-medium",
            "yi-vl-plus",
            "zai-org/GLM-4.5",
            "zai-org/GLM-4.5-Air"
        ],
        }
      ],
      HOST: HOST,
      PORT: servicePort,
      LOG_FILE: join(
        homedir(),
        ".aihubmix-claude-code",
        "aihubmix-claude-code.log"
      ),
    },
  });
  server.addHook("preHandler", apiKeyAuth(config));
  server.addHook("preHandler", async (req: any, reply: any) => {
    if(req.url.startsWith("/v1/messages")) {
      router(req, reply, config)
    }
  });
  server.start();
}

export { run };
// run();
